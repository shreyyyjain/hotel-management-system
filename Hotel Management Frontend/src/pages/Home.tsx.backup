import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import toast from 'react-hot-toast';
import apiClient from '../services/apiClient';
import type { Room, FoodItem } from '../types';
import { authService } from '../services/authService';

export default function Home() {
  const [rooms, setRooms] = useState<Room[]>([]);
  const [foodItems, setFoodItems] = useState<FoodItem[]>([]);
  const [selectedRooms, setSelectedRooms] = useState<number[]>([]);
  const [selectedFood, setSelectedFood] = useState<{ [key: number]: number }>({});
  const [loading, setLoading] = useState(true);
  const [bookingLoading, setBookingLoading] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);
  const navigate = useNavigate();
  const user = authService.getCurrentUser();
  const [activeTab, setActiveTab] = useState<'rooms' | 'food'>('rooms');

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [roomsRes, foodRes] = await Promise.all([
        apiClient.get('/rooms?size=100'),
        apiClient.get('/food-items?size=100')
      ]);
      setRooms(roomsRes.data.content || roomsRes.data);
      setFoodItems(foodRes.data.content || foodRes.data);
    } catch (error) {
      console.error('Failed to load data:', error);
      toast.error('Failed to load data. Please refresh the page.');
    } finally {
      setLoading(false);
    }
  };

  const toggleRoom = (roomId: number) => {
    setSelectedRooms(prev =>
      prev.includes(roomId)
        ? prev.filter(id => id !== roomId)
        : [...prev, roomId]
    );
  };

  const updateFoodQuantity = (foodId: number, quantity: number) => {
    if (quantity <= 0) {
      const newFood = { ...selectedFood };
      delete newFood[foodId];
      setSelectedFood(newFood);
    } else {
      setSelectedFood({ ...selectedFood, [foodId]: quantity });
    }
  };

  const calculateTotal = () => {
    const roomTotal = selectedRooms.reduce((sum, roomId) => {
      const room = rooms.find(r => r.id === roomId);
      return sum + (room?.pricePerNight || 0);
    }, 0);

    const foodTotal = Object.entries(selectedFood).reduce((sum, [foodId, qty]) => {
      const item = foodItems.find(f => f.id === Number(foodId));
      return sum + (item?.price || 0) * qty;
    }, 0);

    return roomTotal + foodTotal;
  };

  const handleBooking = async () => {
    if (selectedRooms.length === 0) {
      toast.error('Please select at least one room');
      return;
    }

    setBookingLoading(true);
    try {
      const bookingData = {
        roomIds: selectedRooms,
        foodItems: Object.entries(selectedFood).map(([foodItemId, quantity]) => ({
          foodItemId: Number(foodItemId),
          quantity
        }))
      };

      await apiClient.post('/bookings', bookingData);
      toast.success('‚ú® Booking created! Check your email for confirmation.');
      setShowSuccess(true);
      setSelectedRooms([]);
      setSelectedFood({});
      
      setTimeout(() => {
        setShowSuccess(false);
      }, 5000);
    } catch (error: any) {
      const errorMessage = error.response?.data?.error || error.response?.data?.message || 'Booking failed. Please try again.';
      toast.error(errorMessage);
    } finally {
      setBookingLoading(false);
    }
  };

  const handleLogout = () => {
    authService.logout();
    navigate('/login');
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          <p className="mt-4 text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex justify-between items-center mb-4">
            <h1 className="font-heading text-heading-md font-bold text-gray-900 uppercase">üè® Hotel Management</h1>
            <div className="flex items-center gap-4">
              <button
                onClick={() => navigate('/dashboard')}
                className="font-heading px-4 py-2 text-sm font-medium text-gray-700 hover:text-primary uppercase"
              >
                Dashboard
              </button>
              <button
                onClick={() => navigate('/bookings')}
                className="font-heading px-4 py-2 text-sm font-medium text-gray-700 hover:text-primary uppercase"
              >
                My Bookings
              </button>
              <span className="text-sm text-gray-600">Welcome, {user?.fullName}</span>
              <button
                onClick={handleLogout}
                className="font-heading px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-secondary uppercase"
              >
                Logout
              </button>
            </div>
          </div>
          
          {/* Tab Navigation */}
          <div className="flex gap-4 border-b">
            <button
              onClick={() => setActiveTab('rooms')}
              className={`font-heading px-6 py-3 font-bold uppercase tracking-heading transition-all ${
                activeTab === 'rooms'
                  ? 'text-primary border-b-4 border-primary'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              üè® Rooms
            </button>
            <button
              onClick={() => setActiveTab('food')}
              className={`font-heading px-6 py-3 font-bold uppercase tracking-heading transition-all ${
                activeTab === 'food'
                  ? 'text-primary border-b-4 border-primary'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              üçΩÔ∏è Food Menu
            </button>
          </div>
        </div>
      </header>

      {/* Success Message */}
      {showSuccess && (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
          <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
            ‚úÖ Booking created successfully! Check your email for confirmation.
          </div>
        </div>
      )}

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-36">
        {/* Rooms Section */}
        {activeTab === 'rooms' && (
        <section className="mb-16">
          <div className="flex justify-between items-center mb-8">
            <h2 className="font-heading text-heading-md font-bold text-gray-900 uppercase tracking-heading">Available Rooms</h2>
            <div className="flex gap-4">
              <input
                type="text"
                placeholder="Search rooms..."
                className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
              <select className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">All Types</option>
                <option value="SINGLE">Single</option>
                <option value="DOUBLE">Double</option>
                <option value="SUITE">Suite</option>
              </select>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {rooms.filter(r => r.available).map((room) => (
              <div
                key={room.id}
                className={`bg-white rounded-xl shadow-md overflow-hidden cursor-pointer transition-all hover:scale-[1.02] ${
                  selectedRooms.includes(room.id)
                    ? 'ring-4 ring-primary shadow-2xl'
                    : 'hover:shadow-xl'
                }`}
                onClick={() => toggleRoom(room.id)}
              >
                {/* Room Image */}
                <div className="h-48 bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                  <span className="text-6xl">üè®</span>
                </div>
                <div className="p-8">
                <div className="flex justify-between items-start mb-6">
                  <div>
                    <h3 className="font-heading text-xl font-bold text-gray-900 uppercase tracking-heading">
                      Room {room.roomNumber}
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">{room.roomType}</p>
                  </div>
                  {selectedRooms.includes(room.id) && (
                    <span className="text-primary text-3xl">‚úì</span>
                  )}
                </div>
                <div className="flex justify-between items-center">
                  <span className="font-heading text-3xl font-bold text-primary">
                    ‚Çπ{room.pricePerNight.toLocaleString('en-IN')}
                  </span>
                  <span className="text-xs text-gray-500 uppercase">per night</span>
                </div>
                </div>
              </div>
            ))}
          </div>
        </section>
        )}
        {/* Food Items Section */}
        {activeTab === 'food' && (
        <section className="mb-16">
          <div className="flex justify-between items-center mb-8">
            <h2 className="font-heading text-heading-md font-bold text-gray-900 uppercase tracking-heading">Food Menu</h2>
            {foodItems.map((item) => (
              <div key={item.id} className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all">
                {/* Food Image */}
                <div className="h-48 bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center">
                  <span className="text-6xl">üçΩÔ∏è</span>
                </div>
                <div className="p-8">
                <div className="flex justify-between items-start mb-6">
                placeholder="Search food..."
                className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
              <select className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">All Cuisines</option>
                <option value="indian">Indian</option>
                <option value="chinese">Chinese</option>
                <option value="continental">Continental</option>
              </select>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">-8 uppercase tracking-heading">Food Menu</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {foodItems.map((item) => (
              <div key={item.id} className="bg-white rounded-xl shadow-md p-8 hover:shadow-xl transition-all">
                <div className="flex justify-between items-start mb-6">
                    +
                  </button>
                </div>
                </div>
              </div>
            ))}   <span className="font-heading text-2xl font-bold text-primary ml-4">‚Çπ{item.price.toLocaleString('en-IN')}</span>
                </div>
                <div className="flex items-center gap-4">
                  <button
                    onClick={() => updateFoodQuantity(item.id, (selectedFood[item.id] || 0) - 1)}
                    className="font-heading w-10 h-10 flex items-center justify-center bg-gray-200 rounded-lg hover:bg-gray-300 text-lg font-bold transition-colors"
                  >
                    ‚àí
                  </button>
                  <span className="font-heading text-xl font-bold w-12 text-center">
                    {selectedFood[item.id] || 0}
                  </span>
                  <button
                    onClick={() => updateFoodQuantity(item.id, (selectedFood[item.id] || 0) + 1)}
                    className="font-heading w-10 h-10 flex items-center justify-center bg-primary text-white rounded-lg hover:bg-secondary text-lg font-bold transition-colors"
                  >
                    +
                  </button>
                </div>
                </div>
              </div>
            ))}
          </div>
        </section>
        )}

        {/* Booking Summary */}
        {(selectedRooms.length > 0 || Object.keys(selectedFood).length > 0) && (
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-blue-50 shadow-2xl backdrop-blur-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                  <p className="text-sm text-gray-600 mb-1">
                    {selectedRooms.length} room(s) ‚Ä¢ {Object.keys(selectedFood).length} food item(s)
                  </p>
                  <p className="font-heading text-3xl font-bold text-gray-900">
                    Total: ‚Çπ{calculateTotal().toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </p>
                </div>
                <button
                  onClick={handleBooking}
                  disabled={bookingLoading || selectedRooms.length === 0}
                  className="font-heading px-10 py-4 bg-primary text-white rounded-xl font-bold text-lg hover:bg-secondary disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-heading shadow-lg hover:shadow-xl transition-all"
                >
                  {bookingLoading ? 'Processing...' : 'Book Now'}
                </button>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
